name: Gerenciador de Codespaces

on:
  schedule:
    # -----------------------------------------------------------------
    # ATENÇÃO: Horários estão em UTC (Sem fuso de verão)
    # Brasília (UTC-3) é 3 horas ATRÁS do UTC.
    # -----------------------------------------------------------------

    # Para parar às 02:00 (Brasília), agende para 05:00 UTC
    - cron: '0 5 * * *'

    # Para ligar às 20:00 (Brasília), agende para 23:00 UTC
    - cron: '0 23 * * *'

jobs:
  manage-codespaces:
    runs-on: ubuntu-latest
    steps:
      # Decide qual ação tomar baseado no 'cron' que disparou o job
      - name: Definir Ação (Parar)
        if: contains(github.event.schedule, '0 5 * * *')
        run: echo "ACTION_TO_TAKE=stop" >> $GITHUB_ENV
      
      - name: Definir Ação (Ligar)
        if: contains(github.event.schedule, '0 23 * * *')
        run: echo "ACTION_TO_TAKE=start" >> $GITHUB_ENV

      # Login no GitHub CLI usando o Token que você salvou
      - name: Autenticar com GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: gh auth login --with-token <<< "$GH_TOKEN"

      # --- AÇÃO DE PARAR ---
      # Este script para TODOS os seus codespaces que estiverem rodando
      - name: Ação: Parar Codespaces
        if: env.ACTION_TO_TAKE == 'stop'
        run: |
          echo "Procurando e parando todos os codespaces ativos..."
          gh codespace list --json name,state | jq -r '.[] | select(.state == "Running") | .name' | \
          while read -r codesa_name; do
            echo "Parando $codesa_name..."
            gh codespace stop -c "$codesa_name"
          done
          echo "Processo de parada concluído."

      # --- AÇÃO DE LIGAR ---
      # Este script liga o primeiro codespace que encontrar
      # associado a ESTE repositório.
      - name: Ação: Ligar Codespace
        if: env.ACTION_TO_TAKE == 'start'
        run: |
          echo "Procurando codespace para este repositório (${{ github.repository }})..."
          CODESPACE_TO_START=$(gh codespace list --repo ${{ github.repository }} --json name,state | jq -r '.[] | select(.state != "Running") | .name' | head -n 1)
          
          if [ -z "$CODESPACE_TO_START" ]; then
            echo "Nenhum codespace parado encontrado para este repositório."
          else
            echo "Iniciando $CODESPACE_TO_START..."
            gh codespace start -c "$CODESPACE_TO_START"
          fi
