name: Gerenciador de Codespaces

on:
  schedule:
    # Segunda, terça, quarta e sexta -> 16:00
    - cron: '0 19 * * 1-3,5'        # quinta (4) excluída
    # Segunda, terça, quarta e sexta -> 00:00 parar
    - cron: '0 3 * * 2-4,6'         # quinta (5) e domingo (0) excluídos / após meia-noite UTC

    # Sexta e sábado -> 18:00 abrir
    - cron: '0 21 * * 5,6'
    # Sexta e sábado -> 02:00 fechar (UTC: 05:00)
    - cron: '0 5 * * 6,0'

  workflow_dispatch:
    inputs:
      action:
        description: "Ação manual: 'start' ou 'stop'"
        required: false
        default: ''

jobs:

  start-codespace:
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'start'
      ||
      (github.event_name == 'schedule' &&
        (
          github.event.schedule == '0 19 * * 1-3,5' ||
          github.event.schedule == '0 21 * * 5,6'
        )
      )
    runs-on: ubuntu-latest
    steps:
      - name: Ligar Codespace
        env:
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: |
          echo "Procurando codespace parado..."
          CODESPACE_TO_START=$(gh codespace list --repo ${{ github.repository }} --json name,state |
            jq -r '.[] | select(.state != "Available") | .name' | head -n 1)

          if [ -z "$CODESPACE_TO_START" ]; then
            echo "Nenhum codespace parado encontrado."
            exit 0
          fi

          echo "Iniciando $CODESPACE_TO_START..."
          gh api -X POST "/user/codespaces/$CODESPACE_TO_START/start"
          echo "Codespace iniciado com sucesso!"

          echo "Aguardando Codespace iniciar..."
          sleep 25

          echo "Executando script dentro do Codespace..."
          gh codespace ssh -c "$CODESPACE_TO_START" -- << 'EOF'
          LOGFILE="/workspaces/startup-check.log"

          echo "===== Startup Check =====" > $LOGFILE
          echo "Data: $(date)" >> $LOGFILE
          echo "" >> $LOGFILE

          echo "--- Verificando Playit ---" >> $LOGFILE
          if pgrep -x "playit" > /dev/null; then
              echo "Playit já estava rodando." >> $LOGFILE
          else
              echo "Playit não está ativo. Iniciando..." >> $LOGFILE
              nohup playit > /workspaces/playit.log 2>&1 &
              sleep 2
              if pgrep -x "playit" > /dev/null; then
                  echo "Playit iniciado com sucesso." >> $LOGFILE
              else
                  echo "Falha ao iniciar o Playit." >> $LOGFILE
              fi
          fi

          echo "" >> $LOGFILE
          echo "--- Reiniciando Crafty (sempre inicia) ---" >> $LOGFILE

          pkill -f "crafty" 2>/dev/null || true
          sleep 1

          nohup bash /workspaces/Minecraft-Server/minecraft/run_crafty.sh > /workspaces/crafty.log 2>&1 &
          sleep 3

          if pgrep -f "crafty" > /dev/null; then
              echo "Crafty iniciado com sucesso." >> $LOGFILE
          else
              echo "Falha ao iniciar o Crafty." >> $LOGFILE
          fi

          echo "" >> $LOGFILE
          echo "===== Fim do Check =====" >> $LOGFILE
EOF
          echo "Script iniciado com sucesso!"

  stop-codespace:
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'stop'
      ||
      (github.event_name == 'schedule' &&
        (
          github.event.schedule == '0 3 * * 2-4,6' ||
          github.event.schedule == '0 5 * * 6,0'
        )
      )
    runs-on: ubuntu-latest
    steps:
      - name: Parar Codespaces
        env:
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: |
          echo "Listando Codespaces..."
          CODESPACES=$(gh codespace list --json name,state \
            | jq -r '.[] | select(.state=="Available" or .state=="Running") | .name')

          echo "Encontrados:"
          echo "$CODESPACES"

          if [ -z "$CODESPACES" ]; then
            echo "Nenhum Codespace elegível para stop."
            exit 0
          fi

          for cs in $CODESPACES; do
            echo "Parando $cs..."
            gh codespace stop --codespace "$cs"
          done

          echo "Processo concluído."
