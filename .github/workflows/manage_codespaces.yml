name: Gerenciador de Codespaces

on:
  schedule:
    - cron: '0 5 * * *'
    - cron: '0 23 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'start ou stop (opcional). Se não informado, a execução segue o horário UTC.'
        required: false
        default: ''

jobs:
  start-codespace:
    runs-on: ubuntu-latest
    steps:
      - name: Verificar se deve executar (início)
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.action }}" ] && [ "${{ github.event.inputs.action }}" != "start" ]; then
              echo "workflow_dispatch com action diferente de 'start' — pulando."
              exit 0
            fi
            echo "Execução manual detectada — procedendo com start."
          else
            HOUR=$(date -u +%H)
            if [ "$HOUR" != "23" ]; then
              echo "Horário UTC atual: $HOUR — não é 23. Pulando job de start."
              exit 0
            fi
            echo "Horário 23 UTC — iniciando job de start."
          fi

      - name: Instalar gh e jq (garantir CLI recente)
        run: |
          set -euo pipefail
          sudo apt-get update -y
          # Try simple apt install first; fallback to official repo install if older package
          if ! sudo apt-get install -y gh jq; then
            echo "apt install failed or older gh; installing gh from official repository..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg >/dev/null 2>&1
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update -y
            sudo apt-get install -y gh jq
          fi
          gh --version

      - name: Autenticar gh (usar secret CODESPACE_PAT)
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
        run: |
          set -euo pipefail
          if [ -z "${CODESPACE_PAT:-}" ]; then
            echo "Segredo CODESPACE_PAT não definido. Abortando."
            exit 1
          fi
          # Print length (masked](#)*
