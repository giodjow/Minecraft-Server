name: Gerenciador de Codespaces

on:
  schedule:
    # Para parar às 02:00 (Brasília), agende para 05:00 UTC
    - cron: '0 5 * * *'
    # Para ligar às 20:00 (Brasília), agende para 23:00 UTC
    - cron: '0 23 * * *'
  
  # Gatilho para teste manual
  workflow_dispatch:

jobs:
  #=======================================================
  # JOB #1: LIGAR O CODESPACE
  #=======================================================
  start-codespace:
    if: github.event.schedule == '0 23 * * *' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Atualizar GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh
      
      - name: Ação Ligar Codespace
        env:
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: |
          echo "Procurando codespace para este repositório (${{ github.repository }})..."
          CODESPACE_TO_START=$(gh codespace list --repo ${{ github.repository }} --json name,state | jq -r '.[] | select(.state != "Running") | .name' | head -n 1)
          
          if [ -z "$CODESPACE_TO_START" ]; then
            echo "Nenhum codespace parado encontrado para este repositório."
          else
            echo "Iniciando $CODESPACE_TO_START..."
            gh codespace start "$CODESPACE_TO_START"
          fi

  #=======================================================
  # JOB #2: DESLIGAR O CODESPACE
  #=======================================================
  stop-codespace:
    if: github.event.schedule == '0 5 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Atualizar GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Ação Parar Codespaces
        env:
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: |
          echo "Procurando e parando todos os codespaces ativos..."
          gh codespace list --json name,state | jq -r '.[] | select(.state == "Running") | .name' | \
          while read -r codesa_name; do
            echo "Parando $codesa_name..."
            gh codespace stop "$codesa_name"
          done
          echo "Processo de parada concluído."
