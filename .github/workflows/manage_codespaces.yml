name: Gerenciador de Codespaces

on:
  schedule:
    # Para parar às 02:00 (Brasília), agende para 05:00 UTC
    - cron: '0 5 * * *'
    # Para ligar às 20:00 (Brasília), agende para 23:00 UTC
    - cron: '0 23 * * *'
  
  # Gatilho para teste manual
  workflow_dispatch:
    inputs:
      action:
        description: "Ação manual: 'start' ou 'stop'"
        required: false
        default: '' # Se vazio, não faz nada manual

jobs:
  #=======================================================
  # JOB #1: LIGAR O CODESPACE
  #=======================================================
  start-codespace:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 23 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'start')
    runs-on: ubuntu-latest
    steps:
      - name: Instalar gh e jq (garantir CLI recente)
        run: |
          set -euo pipefail
          sudo apt-get update -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update -y
          sudo apt-get install -y gh jq
          echo "--- Versão do GH recém-instalado ---"
          /usr/bin/gh --version

      - name: Ação Ligar Codespace
        env:
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: |
          echo "Procurando codespace parado para este repositório (${{ github.repository }})..."
          # FORÇANDO O CAMINHO CORRETO DO 'gh'
          CODESPACE_TO_START=$(/usr/bin/gh codespace list --repo ${{ github.repository }} --json name,state | jq -r '.[] | select(.state != "Running") | .name' | head -n 1)
          
          if [ -z "$CODESPACE_TO_START" ]; then
            echo "Nenhum codespace parado encontrado para este repositório."
          else
            echo "Iniciando $CODESPACE_TO_START..."
            # FORÇANDO O CAMINHO CORRETO DO 'gh'
            /usr/bin/gh codespace start --codespace "$CODESPACE_TO_START"
          fi

  #=======================================================
  # JOB #2: DESLIGAR O CODESPACE
  #=======================================================
  stop-codespace:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 5 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'stop')
    runs-on: ubuntu-latest
    steps:
      - name: Instalar gh e jq (garantir CLI recente)
        run: |
          set -euo pipefail
          sudo apt-get update -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update -y
          sudo apt-get install -y gh jq
          echo "--- Versão do GH recém-instalado ---"
          /usr/bin/gh --version

      - name: Ação Parar Codespaces
        env:
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: |
          echo "Procurando e parando todos os codespaces ativos..."
          # FORÇANDO O CAMINHO CORRETO DO 'gh'
          /usr/bin/gh codespace list --json name,state | jq -r '.[] | select(.state == "Running") | .name' | \
          while read -r codesa_name; do
            echo "Parando $codesa_name..."
            # FORÇANDO O CAMINHO CORRETO DO 'gh'
            /usr/bin/gh codespace stop --codespace "$codesa_name"
          done
          echo "Processo de parada concluído."
