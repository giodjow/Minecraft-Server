name: Gerenciador de Codespaces

on:
  schedule:
    # Para parar às 02:00 (Brasília), agende para 05:00 UTC
    - cron: '0 5 * * *'
    # Para ligar às 20:00 (Brasília), agende para 23:00 UTC
    - cron: '0 23 * * *'
  
  # Gatilho para teste manual
  workflow_dispatch:
    inputs:
      action:
        description: "Ação manual: 'start' ou 'stop'"
        required: false
        default: ''

jobs:
  #=======================================================
  # JOB #1: LIGAR O CODESPACE
  #=======================================================
  start-codespace:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 23 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'start')
    runs-on: ubuntu-latest
    steps:
      - name: Ação Ligar Codespace (via SSH)
        env:
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: |
          echo "Procurando codespace parado para este repositório (${{ github.repository }})..."
          CODESPACE_TO_START=$(gh codespace list --repo ${{ github.repository }} --json name,state | jq -r '.[] | select(.state != "Running") | .name' | head -n 1)
          
          if [ -z "$CODESPACE_TO_START" ]; then
            echo "Nenhum codespace parado encontrado para este repositório."
          else
            echo "Iniciando $CODESPACE_TO_START..."
            # TRUQUE: Usamos 'ssh' com um comando 'echo' para forçar o start
            # A sintaxe é 'gh codespace ssh <nome>' (sem flag), como aprendemos com os erros
            gh codespace ssh "$CODESPACE_TO_START" -- "echo 'Workflow: Codespace iniciado com sucesso'"
          fi

  #=======================================================
  # JOB #2: DESLIGAR O CODESPACE
  #=======================================================
  stop-codespace:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 5 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'stop')
    runs-on: ubuntu-latest
    steps:
      - name: Ação Parar Codespaces
        env:
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: |
          echo "Procurando e parando todos os codespaces ativos..."
          gh codespace list --json name,state | jq -r '.[] | select(.state == "Running") | .name' | \
          while read -r codesa_name; do
            echo "Parando $codesa_name..."
            # O comando 'stop' existe na lista e usa a sintaxe sem flag
            gh codespace stop "$codesa_name"
          done
          echo "Processo de parada concluído."
