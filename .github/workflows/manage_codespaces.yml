name: Gerenciador de Codespaces

on:
  schedule:
    # Para parar às 02:00 (Brasília), agende para 05:00 UTC
    - cron: '0 5 * * *'
    # Para ligar às 20:00 (Brasília), agende para 23:00 UTC
    - cron: '0 23 * * *'
  
  # Gatilho para teste manual
  workflow_dispatch:
    inputs:
      action:
        description: "Ação manual: 'start' ou 'stop'"
        required: false
        default: '' # Se vazio, não faz nada manual

jobs:
  #=======================================================
  # JOB #1: LIGAR O CODESPACE
  #=======================================================
  start-codespace:
    # Roda se:
    # 1. O agendamento for 23:00 UTC
    # 2. O gatilho manual for 'start'
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 23 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'start')
    runs-on: ubuntu-latest
    steps:
      - name: Instalar gh e jq (garantir CLI recente)
        run: |
          set -euo pipefail
          sudo apt-get update -y
          # Instala a CLI oficial do GitHub para garantir a versão mais recente
          # (corrige os erros de "start" ou "--codespace" não encontrados)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update -y
          sudo apt-get install -y gh jq
          gh --version

      - name: Ação: Ligar Codespace
        env:
          # A autenticação é passada diretamente para o comando
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: |
          echo "Procurando codespace parado para este repositório (${{ github.repository }})..."
          CODESPACE_TO_START=$(gh codespace list --repo ${{ github.repository }} --json name,state | jq -r '.[] | select(.state != "Running") | .name' | head -n 1)
          
          if [ -z "$CODESPACE_TO_START" ]; then
            echo "Nenhum codespace parado encontrado para este repositório."
          else
            echo "Iniciando $CODESPACE_TO_START..."
            gh codespace start --codespace "$CODESPACE_TO_START"
          fi

  #=======================================================
  # JOB #2: DESLIGAR O CODESPACE
  #=======================================================
  stop-codespace:
    # Roda se:
    # 1. O agendamento for 05:00 UTC
    # 2. O gatilho manual for 'stop'
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 5 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'stop')
    runs-on: ubuntu-latest
    steps:
      - name: Instalar gh e jq (garantir CLI recente)
        run: |
          set -euo pipefail
          sudo apt-get update -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update -y
          sudo apt-get install -y gh jq
          gh --version

      - name: Ação: Parar Codespaces
        env:
          GH_TOKEN: ${{ secrets.CODESPACE_PAT }}
        run: |
          echo "Procurando e parando todos os codespaces ativos..."
          # Este script para TODOS os codespaces ativos na sua conta
          gh codespace list --json name,state | jq -r '.[] | select(.state == "Running") | .name' | \
          while read -r codesa_name; do
            echo "Parando $codesa_name..."
            gh codespace stop --codespace "$codesa_name"
          done
          echo "Processo de parada concluído."
            echo "Segredo CODESPACE_PAT não definido. Abortando."
            exit 1
          fi
          # Print length (masked](#)*
